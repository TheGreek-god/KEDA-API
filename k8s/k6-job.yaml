# ---
# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: k6-loadtest
#   namespace: performance-test
# spec:
#   template:
#     spec:
#       containers:
#       - name: k6
#         image: grafana/k6:latest
#         command: ["k6", "run", "--out", "influxdb=http://influxdb-service.influxdb.svc.cluster.local:8086/k6", "/scripts/performance-test.js"]
#         env:
#         - name: ENDPOINT
#           value: "http://myidentity-service.default.svc.cluster.local:4000/crocodiles"
#         volumeMounts:
#         - name: k6-scripts
#           mountPath: /scripts
#       restartPolicy: Never
#       volumes:
#       - name: k6-scripts
#         configMap:
#           name: k6-scripts
# ---
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: k6-scripts
# data:
#   performance-test.js: |
#     import { check, sleep } from 'k6';
#     import http from "k6/http";

#     export let options = {
#       stages: [
#         { duration: '1m', target: 50 },
#         { duration: '1m', target: 150 },
#         { duration: '1m', target: 300 },
#         { duration: '2m', target: 500 },
#         { duration: '2m', target: 800 },
#         { duration: '3m', target: 1200 },
#         { duration: '3m', target: 50 },
#       ],
#     };

#     export default function () {
#       let r = http.get(`${__ENV.ENDPOINT}`);
#       check(r, {
#         'status is 200': r => r.status === 200,
#       });
#       sleep(3);
#     }


---
apiVersion: batch/v1
kind: Job
metadata:
  name: k6-loadtest
  namespace: performance-test  # Job is in performance-test
spec:
  template:
    spec:
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6", "run", "--out", "influxdb=http://influxdb-service.influxdb.svc.cluster.local:8086/k6", "/scripts/performance-test.js"]
        env:
        - name: ENDPOINT
          value: "http://myidentity-service.api-app.svc.cluster.local:4000/my-identity"  # â† CHANGED: api-app not default
        volumeMounts:
        - name: k6-scripts
          mountPath: /scripts
      restartPolicy: Never
      volumes:
      - name: k6-scripts
        configMap:
          name: k6-scripts
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: performance-test  # â† ADD THIS: ConfigMap must be in same namespace
data:
  performance-test.js: |
    import { check, sleep } from 'k6';
    import http from "k6/http";

    export let options = {
      stages: [
        { duration: '1m', target: 50 },
        { duration: '1m', target: 150 },
        { duration: '1m', target: 300 },
        { duration: '2m', target: 500 },
        { duration: '2m', target: 800 },
        { duration: '3m', target: 1200 },
        { duration: '3m', target: 50 },
      ],
    };

    export default function () {
      let r = http.get(`${__ENV.ENDPOINT}`);
      check(r, {
        'status is 200': r => r.status === 200,
      });
      sleep(3);
    }